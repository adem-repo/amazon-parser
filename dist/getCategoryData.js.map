{"version":3,"file":"getCategoryData.js","sourceRoot":"","sources":["../src/getCategoryData.ts"],"names":[],"mappings":"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","sourcesContent":["import * as $ from 'cheerio';\nimport getBookRank from './getBookRank';\nimport * as puppeteer from \"puppeteer\";\nimport to from 'await-to-js';\nimport { Constants } from './constants';\nimport { addDocument } from './db_connection';\n\nconst getCategoryData = async (url) => {\n\n\tconst browser = await puppeteer.launch(/*{headless: false}*/);\n\n\tconst [error, page] = await to(browser.newPage());\n\tif (!page) {\n\t\tconsole.log('Page not opened', error);\n\t\treturn;\n\t}\n\n\tpage.on('error', () => {\n\t\tconsole.log('Something goes wrong');\n\t\tprocess.exit();\n\t});\n\n\tlet pageToUrl = await to(page.goto(url));\n\tif (!pageToUrl) {\n\t\tconsole.log('Page isn\\'t on url', error);\n\t\treturn;\n\t}\n\n\tconst pageContent = await page.content();\n\n\t// Elements selectors\n\tconst currentCategorySelector = `.zg_selected`;\n\tconst categoryBooksLinkSelector = `.zg-item > a.a-link-normal`;\n\n\t// Getting current category title\n\tconst currentCategoryTitle = $(currentCategorySelector, pageContent)['0'].children[0].data;\n\n\t// Getting current category child categories\n\tlet childCategories: any|never[] = [];\n\tlet nextToParent = $(currentCategorySelector, pageContent)\n\t\t.parent()\n\t\t.next();\n\n\tif (nextToParent && nextToParent[0]) {\n\t\tif (nextToParent[0].name === 'ul' && nextToParent.children()) {\n\t\t\tnextToParent.children().each((i, item) => childCategories.push({\n\t\t\t\tcategoryTitle: item.children[0].children[0].data,\n\t\t\t\tcategoryURI: item.children[0].attribs.href\n\t\t\t}));\n\t\t}\n\t}\n\n\t// Getting current category books data\n\tconst categoryBooks = $(categoryBooksLinkSelector, pageContent)\n\t\t.map((i, item) => ({\n\t\t\tbookTitle: ( () => {\n\t\t\t\ttry {\n\t\t\t\t\treturn item.children[2].children[0].data\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.log(item, item.children[2], item.children[2].children[0])\n\t\t\t\t}\n\t\t\t})(),\n\t\t\tbookURI: `${Constants.amazonAddress}${item.attribs.href}`,\n\t\t})).get();\n\n\t//Getting rank for each book\n\tlet categoryBooksWithRankPromises = categoryBooks.map( async book => {\n\t\tbook.bookRank = await getBookRank(book.bookURI, browser);\n\t\treturn book;\n\t});\n\n\tlet categoryBooksWithRank: any = [];\n\tawait Promise.all(categoryBooksWithRankPromises)\n\t\t.then( data => categoryBooksWithRank = data )\n\t\t.catch(reason => {\n\t\t\tcategoryBooksWithRank = [];\n\t\t\tconsole.log(reason);\n\t\t});\n\n  let categoryData = {\n\t\tcategoryTitle: currentCategoryTitle,\n    categoryURI: url,\n\t\tbooksRank: categoryBooks,\n\t};\n\n  addDocument(categoryData)\n\n\tif (childCategories.length) {\n\t\t// Fast and unstable\n\t\t// childCategories.forEach(async category => {\n\t\t// \tresultData.push(await getCategoryData(category.categoryURI, resultData));\n\t\t// });\n\n\t\t// Slow and stable\n\t\tfor (let i = 0; i < childCategories.length; i++) {\n      await getCategoryData(childCategories[i].categoryURI);\n\t\t}\n\t}\n\n\tawait page.close();\n\tawait browser.close();\n\n};\n\n// getCategoryData('https://www.amazon.com/Best-Sellers-Kindle-Store-Architects-Z/zgbs/digital-text/157631011/ref=zg_bs_nav_kstore_4_157630011', []);\n// getCategoryData('https://www.amazon.com/Best-Sellers-Kind\n// le-Store-Architecture/zgbs/digital-text/157630011/ref=zg_bs_unv_kstore_4_157631011_1', []);\n\nexport default getCategoryData;\n\n//TODO для каждой книги получить ранг: DONE\n//TODO если есть подкатегории, повторить для каждой."]}